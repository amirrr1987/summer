<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TensorFlow.js with Vue 3 and LocalStorage</title>
    <script src="https://unpkg.com/vue@3.2.31/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.8.0/dist/tf.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="app">
      <div class="container mt-5">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h1 class="card-title text-center">
                  جمع دو عدد با TensorFlow.js و ذخیره در LocalStorage
                </h1>
              </div>
              <div class="card-body">
                <form @submit.prevent="sumNumbers">
                  <div class="mb-3">
                    <label for="number1" class="form-label">عدد اول</label>
                    <input
                      v-model.number="number1"
                      type="number"
                      class="form-control"
                      id="number1"
                      placeholder="عدد اول را وارد کنید"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="number2" class="form-label">عدد دوم</label>
                    <input
                      v-model.number="number2"
                      type="number"
                      class="form-control"
                      id="number2"
                      placeholder="عدد دوم را وارد کنید"
                    />
                  </div>
                  <button type="submit" class="btn btn-primary w-100">
                    جمع کن
                  </button>
                </form>
                <div class="mt-3">
                  <p class="text-center fs-4">
                    نتیجه: <strong>{{ result }}</strong>
                  </p>
                  <p class="text-center fs-5">
                    آخرین نتیجه ذخیره‌شده:
                    <strong>{{ lastSavedResult }}</strong>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted } = Vue;

      createApp({
        setup() {
          const number1 = ref(0);
          const number2 = ref(0);
          const result = ref(null);
          const lastSavedResult = ref(null);
          let model;
          let ysMin, ysMax;

          onMounted(async () => {
            const savedResult = localStorage.getItem("lastResult");
            if (savedResult) {
              lastSavedResult.value = JSON.parse(savedResult);
            }

            // بررسی وجود مدل در localStorage
            if (localStorage.getItem("tensorflowjs_models/my-model")) {
              model = await tf.loadLayersModel("localstorage://my-model");
              console.log("Model loaded from localStorage!");
            } else {
              console.log(
                "No model found in localStorage. Training a new model..."
              );
              await trainModel();
            }
          });

          async function trainModel() {
            // ایجاد مدل
            model = tf.sequential();
            model.add(
              tf.layers.dense({
                units: 128,
                inputShape: [2],
                activation: "relu",
              })
            );
            model.add(tf.layers.dense({ units: 64, activation: "relu" }));
            model.add(tf.layers.dense({ units: 32, activation: "relu" }));
            model.add(tf.layers.dense({ units: 1 }));

            // کامپایل مدل
            model.compile({
              optimizer: tf.train.adam(0.001),
              loss: "meanSquaredError",
            });

            // تولید داده‌های آموزشی
            const generateData = (count, min, max) => {
              const data = [];
              for (let i = 0; i < count; i++) {
                const a = Math.floor(Math.random() * (max - min + 1)) + min;
                const b = Math.floor(Math.random() * (max - min + 1)) + min;
                data.push([a, b]);
              }
              return data;
            };

            const xsData = generateData(10000, 1, 1000); // ۱۰۰۰۰ داده تصادفی بین ۱ تا ۱۰۰۰
            const ysData = xsData.map(([a, b]) => [a + b]); // محاسبه جواب‌ها

            const xs = tf.tensor2d(xsData);
            const ys = tf.tensor2d(ysData);

            // نرمال‌سازی داده‌ها
            const xsNormalized = normalize(xs);
            const ysNormalized = normalize(ys);
            ysMin = ys.min();
            ysMax = ys.max();

            // آموزش مدل
            await model.fit(xsNormalized, ysNormalized, {
              epochs: 100,
              batchSize: 32,
              validationSplit: 0.2,
              callbacks: {
                onEpochEnd: (epoch, logs) => {
                  console.log(
                    `Epoch ${epoch}: loss = ${logs.loss}, val_loss = ${logs.val_loss}`
                  );
                },
              },
            });

            console.log("Model trained!");

            // ذخیره مدل در localStorage
            await model.save("localstorage://my-model");
            console.log("Model saved to localStorage!");
          }

          function normalize(tensor) {
            const max = tensor.max();
            const min = tensor.min();
            return tensor.sub(min).div(max.sub(min));
          }

          function denormalize(tensor, min, max) {
            return tensor.mul(max.sub(min)).add(min);
          }

          async function sumNumbers() {
            if (!model) {
              alert("Model is not trained yet!");
              return;
            }

            const input = tf.tensor2d([[number1.value, number2.value]]);
            const inputNormalized = normalize(input);
            const predictionNormalized = model.predict(inputNormalized);
            const prediction = denormalize(predictionNormalized, ysMin, ysMax);
            result.value = prediction.dataSync()[0];
            localStorage.setItem("lastResult", JSON.stringify(result.value));
            lastSavedResult.value = result.value;
          }

          return {
            number1,
            number2,
            result,
            lastSavedResult,
            sumNumbers,
          };
        },
      }).mount("#app");
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

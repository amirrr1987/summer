<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TensorFlow.js با Vue.js - ذخیره و بارگذاری مدل</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&family=Vazirmatn:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body {
        font-family: "Vazirmatn", "Poppins", serif;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <h1>TensorFlow.js با Vue.js</h1>
        <p>دو عدد وارد کنید:</p>
        <input v-model.number="input1" type="number" placeholder="عدد اول" />
        <input v-model.number="input2" type="number" placeholder="عدد دوم" />
        <button @click="predict">پیش‌بینی</button>

        <p v-if="prediction !== null">نتیجه پیش‌بینی: {{ prediction }}</p>
        <p v-else>لطفاً اعداد را وارد کنید و روی دکمه پیش‌بینی کلیک کنید.</p>
      </div>
    </div>
    <script>
      const { createApp, ref, onMounted } = Vue;

      const app = createApp({
        setup() {
          const input1 = ref(null); // عدد اول
          const input2 = ref(null); // عدد دوم
          const prediction = ref(null); // نتیجه پیش‌بینی
          const model = ref(null); // مدل

          // ساخت مدل ساده
          function createModel() {
            const model = tf.sequential();
            model.add(
              tf.layers.dense({
                units: 1,
                inputShape: [2],
              })
            );
            model.compile({
              optimizer: "sgd",
              loss: "meanSquaredError",
            });
            return model;
          }

          // آموزش مدل
          async function trainModel(model) {
            const inputs = tf.tensor2d([
              [1, 2],
              [2, 3],
              [3, 4],
            ]);
            const outputs = tf.tensor2d([[3], [5], [7]]);
            await model.fit(inputs, outputs, { epochs: 100 });
            console.log("Model trained!");
            return model;
          }

          // ذخیره مدل در localStorage
          async function saveModel(model) {
            const savedModel = await model.save("localstorage://my-model");
            console.log("Model saved to localStorage.");
          }

          // بارگذاری مدل از localStorage
          async function loadModel() {
            try {
              const loadedModel = await tf.loadLayersModel(
                "localstorage://my-model"
              );
              console.log("Model loaded from localStorage.");
              return loadedModel;
            } catch (error) {
              console.log("No model found in localStorage. Training new model.");
              return null;
            }
          }

          // پیش‌بینی
          async function predict() {
            if (input1.value === null || input2.value === null) {
              alert("لطفاً هر دو عدد را وارد کنید.");
              return;
            }

            // تبدیل ورودی‌ها به تانسور
            const inputTensor = tf.tensor2d([[input1.value, input2.value]]);

            // انجام پیش‌بینی
            const result = model.value.predict(inputTensor);
            const resultData = await result.data(); // تبدیل به آرایه
            prediction.value = resultData[0].toFixed(2); // ذخیره نتیجه پیش‌بینی
          }

          // هنگام بارگذاری صفحه
          onMounted(async () => {
            let loadedModel = await loadModel();
            if (!loadedModel) {
              loadedModel = createModel();
              await trainModel(loadedModel);
              await saveModel(loadedModel);
            }
            model.value = loadedModel;
          });

          return {
            input1,
            input2,
            prediction,
            predict,
          };
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
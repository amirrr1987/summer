<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TensorFlow.js با Vue.js - نسخه ۱.۳</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&family=Vazirmatn:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body {
        font-family: "Vazirmatn", "Poppins", serif;
        background-color: #f8f9fa;
        padding: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      p {
        margin-top: 20px;
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <h1>TensorFlow.js با Vue.js - نسخه ۱.۳</h1>
        <p>دو عدد وارد کنید:</p>
        <input v-model.number="input1" type="number" placeholder="عدد اول" />
        <input v-model.number="input2" type="number" placeholder="عدد دوم" />
        <button @click="predict">پیش‌بینی</button>

        <p v-if="prediction !== null">نتیجه پیش‌بینی: {{ prediction }}</p>
        <p v-else>لطفاً اعداد را وارد کنید و روی دکمه پیش‌بینی کلیک کنید.</p>
      </div>
    </div>
    <script>
      console.log("Starting script..."); // دیباگ: بررسی اجرای اسکریپت

      const { createApp, ref, onMounted } = Vue;

      console.log("Vue loaded:", Vue); // دیباگ: بررسی بارگذاری Vue

      const app = createApp({
        setup() {
          console.log("App setup..."); // دیباگ: بررسی اجرای setup

          const input1 = ref(null); // عدد اول
          const input2 = ref(null); // عدد دوم
          const prediction = ref(null); // نتیجه پیش‌بینی
          const model = ref(null); // مدل

          // ساخت مدل ساده
          function createModel() {
            console.log("Creating model..."); // دیباگ: بررسی ساخت مدل
            const model = tf.sequential();
            model.add(
              tf.layers.dense({
                units: 1,
                inputShape: [2],
              })
            );
            model.compile({
              optimizer: "sgd",
              loss: "meanSquaredError",
            });
            return model;
          }

          // آموزش مدل
          async function trainModel(model) {
            try {
              console.log("Training model..."); // دیباگ: بررسی آموزش مدل
              const inputs = tf.tensor2d([
                [1, 2],
                [2, 3],
                [3, 4],
              ]);
              const outputs = tf.tensor2d([[3], [5], [7]]);
              await model.fit(inputs, outputs, { epochs: 100 });
              console.log("Model trained!");
              return model;
            } catch (error) {
              alert("خطا در آموزش مدل: " + error.message);
              console.error("Error training model:", error);
            }
          }

          // ذخیره مدل در localStorage
          async function saveModel(model) {
            try {
              console.log("Saving model..."); // دیباگ: بررسی ذخیره مدل
              await model.save("localstorage://my-model");
              console.log("Model saved to localStorage.");
            } catch (error) {
              alert("خطا در ذخیره مدل: " + error.message);
              console.error("Error saving model:", error);
            }
          }

          // بارگذاری مدل از localStorage
          async function loadModel() {
            try {
              console.log("Loading model..."); // دیباگ: بررسی بارگذاری مدل
              const loadedModel = await tf.loadLayersModel(
                "localstorage://my-model"
              );
              console.log("Model loaded from localStorage.");
              return loadedModel;
            } catch (error) {
              console.log("No model found in localStorage. Training new model.");
              return null;
            }
          }

          // پیش‌بینی
          async function predict() {
            try {
              console.log("Predicting..."); // دیباگ: بررسی پیش‌بینی
              if (!model.value) {
                alert("مدل هنوز بارگذاری نشده است. لطفاً چند لحظه صبر کنید.");
                return;
              }

              if (input1.value === null || input2.value === null) {
                alert("لطفاً هر دو عدد را وارد کنید.");
                return;
              }

              const inputTensor = tf.tensor2d([[input1.value, input2.value]]);
              const result = model.value.predict(inputTensor);
              const resultData = await result.data();
              prediction.value = resultData[0].toFixed(2);
            } catch (error) {
              alert("خطا در پیش‌بینی: " + error.message);
              console.error("Error predicting:", error);
            }
          }

          // هنگام بارگذاری صفحه
          onMounted(async () => {
            try {
              console.log("Page mounted..."); // دیباگ: بررسی mount شدن صفحه
              await tf.setBackend('cpu');
              console.log("Backend set to CPU.");

              let loadedModel = await loadModel();
              if (!loadedModel) {
                loadedModel = createModel();
                await trainModel(loadedModel);
                await saveModel(loadedModel);
              }
              model.value = loadedModel;
            } catch (error) {
              alert("خطا در بارگذاری مدل: " + error.message);
              console.error("Error loading model:", error);
            }
          });

          return {
            input1,
            input2,
            prediction,
            predict,
          };
        },
      });

      console.log("Mounting app..."); // دیباگ: بررسی mount شدن اپلیکیشن
      app.mount("#app");
    </script>
  </body>
</html>